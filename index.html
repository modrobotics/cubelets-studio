<html>
<head>
	<title>Cubelets Studio</title>

	<script src="js/jquery.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/d3.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/underscore.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" type="text/css" href="css/ace.css" />

	<style type="text/css">

body {
	background: #111;
	color: #fff;
	margin: 0;
	padding: 0;
	font-family: 'Andale Mono', 'Courier New', monospace;
}

#studio {

}

#studio .titlebar {
	background: #333;
	height: 44px;
}

#studio .titlebar-title {
	line-height: 44px;
	margin: auto;
	text-align: center;
	width: 400px;
	font-size: 1.2em;
	font-weight: bold;
	padding: 0;
}

#studio .titlebar-title-document-name,
#studio .titlebar-title-separator,
#studio .titlebar-title-device-name {
	display: inline-block;
}

#studio .titlebar-connection-status {
	display: inline-block;
	color: #fff;
	background: #444;
	border-top: 1px solid #555;
	border-right: 1px solid #222;
	border-bottom: 1px solid #222;
	border-left: 1px solid #555;
	position: absolute;
	top: 0px;
	right: 0px;
	height: 24px;
	margin: 9px;
}

#studio .titlebar-connection-status-icon {
	background: url(img/connection-disconnected.png);
	width: 20px;
	height: 20px;
	display: inline-block;
	margin: 3px;
	float: left;
}

#studio .titlebar-connection-status-label {
	display: inline-block;
	float: left;
	line-height: 20px;
	margin: 3px 6px;
	font-size: 0.8em;
}

#studio .workspace {
	position: absolute;
	width: 100%;
	top: 44px;
	bottom: 0px;
}

#studio .workspace-programs {
	position: absolute;
	top: 0px;
	left: 0px;
	bottom: 100px;
	width: 300px;
	border-right: 4px solid #333;
	overflow-x: auto;
	overflow-y: scroll;
	background: #111;
}

#studio .workspace-programs-title {
	font-size: 1.1em;
	font-weight: bold;
	margin: 0px;
	padding: 6px;
	text-align: left;
	background-color: rgba(85,97,255,0.5);
}

#studio .workspace-programs-list {
	list-style: inside square;
	padding: 0px;
	margin: 0px;
}

#studio .workspace-programs-list li {
	font-size: 0.9em;
	margin: 6px;
}

#studio .workspace-programs-list li a {
	color: #fff;
	text-decoration: none;
	font-weight: none;
}

#studio .workspace-programs-list li a:hover {
	color: #fff;
	background: rgba(85,97,255,1.0);
}

#studio .workspace-code {
	position: absolute;
	top: 0px;
	left: 300px;
	right: 300px;
	bottom: 100px;
}

#studio .workspace-code-editor {
	position: absolute;
	left: 4px;
	right: 0px;
	top: 33px;
	bottom: 4px;
}

#studio .workspace-code-tabs {
	position: absolute;
	top: 0px;
	left: 6px;
	right: 0px;
	height: 32px;
	border-bottom: 1px solid #333;
}

#studio .workspace-code-tab {
	display: block;
	float: left;
	width: 100px;
	height: 28px;
	line-height: 30px;
	margin: 3px 2px 0px 0px;
	padding: 0px 9px;
	text-align: left;
	background: #333;
	border-top: 1px solid #555;
	border-left: 1px solid #555;
	border-radius: 6px 6px 0px 0px;
	font-size: 0.7em;
	color: #fff;
	text-decoration: none;
}

#studio .workspace-code-tab-active {
	background: rgba(85,97,255,0.5);
	border-top: 1px solid rgba(85,97,255,1);
	border-left: 1px solid rgba(85,97,255,1);
}

#studio .workspace-construction {
	position: absolute;
	top: 0px;
	right: 0px;
	bottom: 100px;
	width: 300px;
	border-left: 4px solid #333;
	background: #111;
}

#studio .workspace-construction-graph {
	width: 300px;
	height: 300px;
	border-bottom: 1px solid #333;
	background: #000;
}

#studio .workspace-construction-graph-circle-near {
	stroke: rgba(85,255,97,0.5);
	stroke-width: 2px;
}

#studio .workspace-construction-graph-circle-far {
	stroke: rgba(51,51,51,1);
	stroke-width: 2px;
	stroke-dasharray: 10px, 5px;
}

#studio .workspace-construction-graph-node {
	opacity: 0.5;
}

#studio .workspace-construction-graph-node-active {
	opacity: 1.0;
}

#studio .console {
	position: absolute;
	height: 100px;
	bottom: 0px;
	left: 0px;
	right: 0px;
	background: #111;
	border-top: 4px solid #333;
}

#studio .dialog {
	display: none;
	background: rgb(1,1,1,0.5);
}

	</style>
</head>
<body>

	<div id="studio">
		<div class="titlebar">
			<h1 class="titlebar-title">
				<div class="titlebar-title-document-name">Untitled.c</div>
				<div class="titlebar-title-separator">&mdash;</div>
				<div class="titlebar-title-device-name">Cubelet</div>
			</h1>
			<a href="#" class="titlebar-connection-status">
				<div class="titlebar-connection-status-icon"></div>
				<div class="titlebar-connection-status-label">Disconnected</div>
			</a>
		</div>
		<div class="workspace">
			<div class="workspace-programs">
				<h2 class="workspace-programs-title">Programs</h2>
				<ul class="workspace-programs-list"></ul>
			</div>
			<div class="workspace-code">
				<div class="workspace-code-tabs"></div>
				<div class="workspace-code-editor"></div>
			</div>
			<div class="workspace-construction">
				<div class="workspace-construction-graph"></div>
				<div class="workspace-construction-details"></div>
			</div>
		</div>
		<div class="console">
			<div class="console-toolbar"></div>
			<div class="console-messages"></div>
		</div>
		<div class="dialog">
			<div class="dialog-error">
				<h3 class="dialog-error-title"></h3>
				<div class="dialog-error-message"></div>
			</div>
			<div class="dialog-connection">
				<h3 class="dialog-connection-title"></h3>
				<ul class="dialog-connection-device-list"></ul>
			</div>
		</div>
	</div>

	<script type="text/javascript">

var cubelets = require('cubelets');
var studio = new (require('./studio'))();

studio.on('load', function() {
	ui.loadProgramList(studio.programs);
});

studio.on('newProgram', function(program) {
	ui.addProgramListItem(program);
	ui.openProgram(program);
});

studio.on('openProgram', function(program) {
	ui.openProgram(program);
});

studio.on('constructionChanged', function() {
	ui.drawWorkspaceConstructionGraph(studio.construction);
});

var ui = {
	// UI Properties
	tabs: [],
	editor: undefined,
	graph: undefined,

	// Initialization
	initialize: function() {
		ui.initializeMenu();
		ui.initializeWorkspaceCodeEditor();
		ui.initializeWorkspaceConstructionGraph();
	},
	initializeMenu: function() {
		var g = require('nw.gui');
		var mainMenu = g.Window.get().menu = new g.Menu({ type: 'menubar' });
		var fileMenuItem = new g.MenuItem({ label: 'File' });
		var fileMenu = fileMenuItem.submenu = new g.Menu();
		fileMenu.append(new g.MenuItem({ label: 'New Program' }));
		fileMenu.append(new g.MenuItem({ label: 'Open' }));
		fileMenu.append(new g.MenuItem({ label: 'Save' }));
		fileMenu.append(new g.MenuItem({ label: 'Save As...' }));
		fileMenu.append(new g.MenuItem({ label: 'Save All' }));
		fileMenu.append(new g.MenuItem({ type: 'separator' }));
		fileMenu.append(new g.MenuItem({ label: 'Close Program' }));
		fileMenu.append(new g.MenuItem({ label: 'Close All Programs' }));
		mainMenu.insert(fileMenuItem, 1);
	},
	initializeWorkspaceCodeEditor: function() {
		var container = d3.select('#studio .workspace-code-editor')[0][0];
		var editor = ace.edit(container);
		editor.setTheme('ace/theme/twilight');
		editor.getSession().setMode('ace/mode/c_cpp');
		editor.setShowPrintMargin(false);
		editor.setFontSize(14);
		ui.editor = editor;
	},
	initializeWorkspaceConstructionGraph: function() {
		var width = 300;
		var height = 300;
		ui.graph = d3.select('#studio .workspace-construction-graph')
			.append('svg:svg')
			.classed('workspace-construction-graph-svg', true)
			.attr('width', width)
			.attr('height', height);
	},

	// Dialogs
	showErrorDialog: function(title, message) {
		console.error(title + ':', message);
	},
	showConnectionDialog: function(devices) {
		d3.select('#studio .dialog-connection-device-list')
			.selectAll('li')
			.data(devices)
			.enter()
				.append('li')
				.text(function(device) {
					return device.comName;
				});
	},

	// Workspace Title Formatting
	setWorkspaceTitle: function(documentName, deviceName) {
		ui.setWorkspaceTitleDocumentName(documentName);
		ui.setWorkspaceTitleDeviceName(deviceName);
		d3.select('#studio .titlebar-title-separator').html((documentName && deviceName) ? '&mdash;' : '');
	},
	setWorkspaceTitleDocumentName: function(documentName) {
		d3.select('#studio .titlebar-title-document-name').text(documentName);
	},
	setWorkspaceTitleDeviceName: function(deviceName) {
		d3.select('#studio .titlebar-title-device-name').text(deviceName);
	},

	// Workspace Code Tabs
	addWorkspaceCodeTab: function(tab) {
		ui.tabs.push(tab);
		var element = d3.select('#studio .workspace-code-tabs')
			.append('a')
			.attr('href', '#')
			.classed('workspace-code-tab', true)
			.text(tab.title)
			.on('click', function() {
				var program = tab.ref.program;
				ui.openProgram(program);
			});
		tab.element = element[0][0];
		ui.setWorkspaceCodeTabActive(tab);
	},
	setWorkspaceCodeTabActive: function(tab) {
		d3.selectAll('#studio .workspace-code-tab')
			.classed('workspace-code-tab-active', false);
		d3.select(tab.element)
			.classed('workspace-code-tab-active', true);
	},
	closeWorkspaceCodeTab: function(tab) {

	},

	// Program List/Display
	loadProgramList: function(programs) {
		d3.select('#studio .workspace-programs-list')
			.selectAll('li')
			.data(studio.programs)
			.enter()
				.append('li')
				.append('a').attr('href', '#')
				.text(function(d) {
					return d.name;
				});
		d3.selectAll('#studio .workspace-programs-list li').each(function(d, i) {
			d3.select(this).on('click', function() {
				studio.openProgram(d);
			});
		});
	},
	addProgramListItem: function(program) {
		d3.select('#studio .workspace-programs-list')
			.insert('li', ':first-child')
			.append('a').attr('href', '#')
			.text(program.name)
			.on('click', function() {
				studio.openProgram(program);
			});
	},
	openProgram: function(program) {
		if (ui.tabs.length === 0) {
			// Initial tab
			var session = ui.editor.getSession();
			session.getDocument().setValue(program.code);
			ui.setWorkspaceTitleDocumentName(program.name);
			ui.addWorkspaceCodeTab({
				type: 'program',
				title: program.name,
				ref: {
					program: program,
					session: session
				}
			});
			return;
		}
		var tab = _(ui.tabs).find(function(tab) {
			return tab.type === 'program' && tab.ref.program === program;
		});
		if (tab) {
			// Tab already exists
			ui.editor.setSession(tab.ref.session);
			ui.setWorkspaceTitleDocumentName(program.name);
			ui.setWorkspaceCodeTabActive(tab);
		}
		else {
			// Create a new tab
			var mode = ui.editor.getSession().getMode();
			var session = new ace.EditSession(program.code, mode);
			ui.editor.setSession(session);
			ui.setWorkspaceTitleDocumentName(program.name);
			ui.addWorkspaceCodeTab({
				type: 'program',
				title: program.name,
				ref: {
					program: program,
					session: session
				}
			});
		}
	},

	// Construction Graph
	getImageForWorkspaceConstructionNode: function(node) {
		return 'img/cubelet-' + node.type.name + '.png';
	},
	setWorkspaceConstructionGraphNodeActive: function(node) {
		d3.selectAll('#studio .workspace-construction-graph-node')
			.classed('workspace-construction-graph-node-active', false);
		d3.select(node.element)
			.classed('workspace-construction-graph-node-active', true);
	},
	drawWorkspaceConstructionGraph: function(construction) {
		var w = 300;
		var h = 300;
		var s = 32;
		var p = (w - s * 5) / 10 + s;
		var cx = w / 2;
		var cy = h / 2;
		var t = 'translate(' + -s / 2 + ',' + -s / 2 + ')';
		function applyNode() {
			this
				.attr('xlink:href', ui.getImageForWorkspaceConstructionNode)
				.attr('width', s)
				.attr('height', s)
				.attr('transform', t)
				.each(function(node) {
					node.element = this;
				})
				.on('click', function(node) {
					ui.setWorkspaceConstructionGraphNodeActive(node);
				});
		}
		function plotX(radius, spokes) {
			return function(node, i) {
				return cx + radius * Math.cos(2 * (i / spokes) * Math.PI + Math.PI / 2);
			}
		}
		function plotY(radius, spokes) {
			return function(node, i) {
				return cy + radius * Math.sin(2 * (i / spokes) * Math.PI + Math.PI / 2);
			}
		}
		ui.graph.selectAll().remove();
		if (construction.far.length > 0) {
			ui.graph
				.append('circle')
				.classed('workspace-construction-graph-circle-far', true)
				.attr({ 'r': 2.5 * p, 'cx': cx, 'cy': cy });
		}
		ui.graph
			.append('circle')
			.classed('workspace-construction-graph-circle-near', true)
			.attr({ 'r': 1.5 * p, 'cx': cx, 'cy': cy });
		ui.graph.selectAll('image.workspace-construction-graph-node-origin')
			.data([construction.origin])
			.enter()
				.append('image')
				.classed('workspace-construction-graph-node', true)
				.classed('workspace-construction-graph-node-origin', true)
				.attr('x', cx)
				.attr('y', cy)
				.call(applyNode);
		ui.graph.selectAll('image.workspace-construction-graph-node-near')
			.data(construction.near)
			.enter()
				.append('image')
				.classed('workspace-construction-graph-node', true)
				.classed('workspace-construction-graph-node-near', true)
				.attr('x', plotX(p, construction.near.length))
				.attr('y', plotY(p, construction.near.length))
				.call(applyNode);
		ui.graph.selectAll('image.workspace-construction-graph-node-far')
			.data(construction.far)
			.enter()
				.append('image')
				.classed('workspace-construction-graph-node', true)
				.classed('workspace-construction-graph-node-far', true)
				.attr('x', plotX(2 * p, construction.far.length))
				.attr('y', plotY(2 * p, construction.far.length))
				.call(applyNode);
	}
};

d3.select('.titlebar-connection-status').on('click', function(e) {
	cubelets.list(function(error, devices) {
		if (error) {
			ui.showErrorDialog('Connection Error', 'Could not list connected cubelets.');
			return;
		}
		ui.showConnectionDialog(devices);
	});
});

ui.initialize();
studio.load();
studio.createNewProgram('Untitled.c');
studio.mockConstruction();

	</script>
</body>
</html>
