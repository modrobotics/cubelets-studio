<html>
<head>
	<title>Cubelets Studio</title>

	<script src="js/jquery.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/d3.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/underscore.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" type="text/css" href="css/ace.css" />

	<style type="text/css">

body {
	background: #111;
	color: #fff;
	margin: 0;
	padding: 0;
	font-family: 'Andale Mono', 'Courier New', monospace;
}

#studio {

}

#studio .titlebar {
	background: #333;
	height: 44px;
}

#studio .titlebar-title {
	line-height: 44px;
	margin: auto;
	text-align: center;
	width: 400px;
	font-size: 1.2em;
	font-weight: bold;
	padding: 0;
}

#studio .titlebar-title-document-name,
#studio .titlebar-title-separator,
#studio .titlebar-title-device-name {
	display: inline-block;
}

#studio .titlebar-connection-status {
	display: inline-block;
	color: #fff;
	background: #444;
	border-top: 1px solid #555;
	border-right: 1px solid #222;
	border-bottom: 1px solid #222;
	border-left: 1px solid #555;
	position: absolute;
	top: 0;
	right: 0;
	height: 24px;
	margin: 9px;
}

#studio .titlebar-connection-status-icon {
	background: url(img/connection-disconnected.png);
	width: 20px;
	height: 20px;
	display: inline-block;
	margin: 3px;
	float: left;
}

#studio .titlebar-connection-status-label {
	display: inline-block;
	float: left;
	line-height: 20px;
	margin: 3px 6px;
	font-size: 0.8em;
}

#studio .workspace {
	position: absolute;
	width: 100%;
	top: 44px;
	bottom: 0px;
}

#studio .workspace-programs {
	position: absolute;
	top: 0px;
	left: 0px;
	bottom: 100px;
	width: 300px;
	border-right: 4px solid #333;
	overflow-x: auto;
	overflow-y: scroll;
	background: #111;
}

#studio .workspace-programs-title {
	font-size: 1.1em;
	font-weight: bold;
	margin: 0px;
	padding: 6px;
	text-align: left;
	background-color: rgba(85,97,255,0.5);
}

#studio .workspace-programs-list {
	list-style: inside square;
	padding: 0px;
	margin: 0px;
}

#studio .workspace-programs-list li {
	font-size: 0.9em;
	margin: 6px;
}

#studio .workspace-programs-list li a {
	color: #fff;
	text-decoration: none;
	font-weight: none;
}

#studio .workspace-programs-list li a:hover {
	color: #fff;
	background: rgba(85,97,255,1.0);
}

#studio .workspace-code {
	position: absolute;
	top: 0px;
	left: 300px;
	right: 300px;
	bottom: 100px;
}

#studio .workspace-code-editor {
	position: absolute;
	left: 4px;
	right: 0px;
	top: 33px;
	bottom: 4px;
}

#studio .workspace-code-tabs {
	position: absolute;
	top: 0px;
	left: 6px;
	right: 0px;
	height: 32px;
	border-bottom: 1px solid #333;
}

#studio .workspace-code-tab {
	display: block;
	float: left;
	width: 100px;
	height: 28px;
	line-height: 30px;
	margin: 3px 2px 0px 0px;
	padding: 0px 9px;
	text-align: left;
	background: #333;
	border-top: 1px solid #555;
	border-left: 1px solid #555;
	border-radius: 6px 6px 0px 0px;
	font-size: 0.7em;
	color: #fff;
	text-decoration: none;
}

#studio .workspace-code-tab-active {
	background: rgba(85,97,255,0.5);
	border-top: 1px solid rgba(85,97,255,1);
	border-left: 1px solid rgba(85,97,255,1);
}

#studio .workspace-construction {
	position: absolute;
	top: 0px;
	right: 0px;
	bottom: 100px;
	width: 300px;
	border-left: 4px solid #333;
	background: #111;
}

#studio .workspace-construction-graph {
	width: 300px;
	height: 300px;
	border-bottom: 1px solid #333;
}

#studio .console {
	position: absolute;
	height: 100px;
	bottom: 0px;
	left: 0px;
	right: 0px;
	background: #111;
	border-top: 4px solid #333;
}

#studio .dialog {
	display: none;
	background: rgb(1,1,1,0.5);
}

	</style>
</head>
<body>

	<div id="studio">
		<div class="titlebar">
			<h1 class="titlebar-title">
				<div class="titlebar-title-document-name">Untitled.c</div>
				<div class="titlebar-title-separator">&mdash;</div>
				<div class="titlebar-title-device-name">Cubelet</div>
			</h1>
			<a href="#" class="titlebar-connection-status">
				<div class="titlebar-connection-status-icon"></div>
				<div class="titlebar-connection-status-label">Disconnected</div>
			</a>
		</div>
		<div class="workspace">
			<div class="workspace-programs">
				<h2 class="workspace-programs-title">Programs</h2>
				<ul class="workspace-programs-list"></ul>
			</div>
			<div class="workspace-code">
				<div class="workspace-code-tabs"></div>
				<div class="workspace-code-editor"></div>
			</div>
			<div class="workspace-construction">
				<div class="workspace-construction-graph"></div>
			</div>
		</div>
		<div class="console">
			<div class="console-toolbar"></div>
			<div class="console-messages"></div>
		</div>
		<div class="dialog">
			<div class="dialog-error">
				<h3 class="dialog-error-title"></h3>
				<div class="dialog-error-message"></div>
			</div>
			<div class="dialog-connection">
				<h3 class="dialog-connection-title"></h3>
				<ul class="dialog-connection-device-list"></ul>
			</div>
		</div>
	</div>

	<script type="text/javascript">

var cubelets = require('cubelets');
var studio = new (require('./studio'))();

studio.on('load', function() {
	ui.loadProgramList(studio.programs);
});

studio.on('newProgram', function(program) {
	ui.addProgramListItem(program);
	ui.openProgramInEditorTab(program);
});

studio.on('openProgram', function(program) {
	ui.openProgramInEditorTab(program);
});

var ui = {
	tabs: [],

	initialize: function() {
		ui.initializeMenu();
		ui.initializeEditor();
	},
	initializeMenu: function() {
		var g = require('nw.gui');
		var mainMenu = g.Window.get().menu = new g.Menu({ type: 'menubar' });
		var fileMenuItem = new g.MenuItem({ label: 'File' });
		var fileMenu = fileMenuItem.submenu = new g.Menu();
		fileMenu.append(new g.MenuItem({ label: 'New Program' }));
		fileMenu.append(new g.MenuItem({ label: 'Open' }));
		fileMenu.append(new g.MenuItem({ label: 'Save' }));
		fileMenu.append(new g.MenuItem({ label: 'Save As...' }));
		fileMenu.append(new g.MenuItem({ label: 'Save All' }));
		fileMenu.append(new g.MenuItem({ type: 'separator' }));
		fileMenu.append(new g.MenuItem({ label: 'Close Program' }));
		fileMenu.append(new g.MenuItem({ label: 'Close All Programs' }));
		mainMenu.insert(fileMenuItem, 1);
	},
	showErrorDialog: function(title, message) {
		console.error(title + ':', message);
	},
	setWorkspaceTitle: function(documentName, deviceName) {
		ui.setWorkspaceTitleDocumentName(documentName);
		ui.setWorkspaceTitleDeviceName(deviceName);
		d3.select('#studio .titlebar-title-separator').html((documentName && deviceName) ? '&mdash;' : '');
	},
	setWorkspaceTitleDocumentName: function(documentName) {
		d3.select('#studio .titlebar-title-document-name').text(documentName);
	},
	setWorkspaceTitleDeviceName: function(deviceName) {
		d3.select('#studio .titlebar-title-device-name').text(deviceName);
	},
	showConnectionDialog: function(devices) {
		d3.select('#studio .dialog-connection-device-list')
			.selectAll('li')
			.data(devices)
			.enter()
				.append('li')
				.text(function(device) {
					return device.comName;
				});
	},
	loadProgramList: function(programs) {
		d3.select('#studio .workspace-programs-list')
			.selectAll('li')
			.data(studio.programs)
			.enter()
				.append('li')
				.append('a').attr('href', '#')
				.text(function(d) {
					return d.name;
				});
		d3.selectAll('#studio .workspace-programs-list li').each(function(d, i) {
			d3.select(this).on('click', function() {
				studio.openProgram(d);
			});
		});
	},
	addProgramListItem: function(program) {
		d3.select('#studio .workspace-programs-list')
			.insert('li', ':first-child')
			.append('a').attr('href', '#')
			.text(program.name)
			.on('click', function() {
				studio.openProgram(program);
			});
	},
	initializeEditor: function() {
		var container = d3.select('#studio .workspace-code-editor')[0][0];
		var editor = ace.edit(container);
		editor.setTheme('ace/theme/twilight');
		editor.getSession().setMode('ace/mode/c_cpp');
		editor.setShowPrintMargin(false);
		editor.setFontSize(14);
		ui.editor = editor;
	},
	addWorkspaceCodeTab: function(tab) {
		ui.tabs.push(tab);
		var element = d3.select('#studio .workspace-code-tabs')
			.append('a')
			.attr('href', '#')
			.attr('class', 'workspace-code-tab')
			.text(tab.title)
			.on('click', function() {
				var program = tab.ref.program;
				ui.openProgramInEditorTab(program);
			});
		tab.element = element[0][0];
		ui.setWorkspaceCodeTabActive(tab);
	},
	setWorkspaceCodeTabActive: function(tab) {
		d3.selectAll('#studio .workspace-code-tab')
			.classed('workspace-code-tab-active', false);
		d3.select(tab.element)
			.classed('workspace-code-tab-active', true);
	},
	closeWorkspaceCodeTab: function(tab) {

	},
	openProgramInEditorTab: function(program) {
		if (ui.tabs.length === 0) {
			// First tab
			var session = ui.editor.getSession();
			session.getDocument().setValue(program.code);
			ui.setWorkspaceTitleDocumentName(program.name);
			ui.addWorkspaceCodeTab({
				type: 'program',
				title: program.name,
				ref: {
					program: program,
					session: session
				}
			});
			return;
		}
		var tab = _(ui.tabs).find(function(tab) {
			return tab.type === 'program' && tab.ref.program === program;
		});
		if (tab) {
			// Tab already exists
			ui.editor.setSession(tab.ref.session);
			ui.setWorkspaceTitleDocumentName(program.name);
			ui.setWorkspaceCodeTabActive(tab);
		}
		else {
			// Create a new tab
			var mode = ui.editor.getSession().getMode();
			var session = new ace.EditSession(program.code, mode);
			ui.editor.setSession(session);
			ui.setWorkspaceTitleDocumentName(program.name);
			ui.addWorkspaceCodeTab({
				type: 'program',
				title: program.name,
				ref: {
					program: program,
					session: session
				}
			});
		}
	}
};

d3.select('.titlebar-connection-status').on('click', function(e) {
	cubelets.list(function(error, devices) {
		if (error) {
			ui.showErrorDialog('Connection Error', 'Could not list connected cubelets.');
			return;
		}
		ui.showConnectionDialog(devices);
	});
});

ui.initialize();
studio.load();
studio.createNewProgram('Untitled.c');

	</script>
</body>
</html>
