var events = require('events');
var util = require('util');
var SerialPort = require('serialport');
var ResponseParser = require('./parser');

var Connection = function(device) {
	events.EventEmitter.call(this);

	this.device = device;
	
	var serial = new SerialPort(device);
	var parser = new ResponseParser();
	var emitter = this;

	serial.on('open', function() {
		console.log('Connected.');

		// Forward open event
		emitter.emit('open');

		// Emit received response
		parser.on('response', function(message) {
			emitter.emit('response', message);
		});
	});

	serial.on('error', function(e) {
		console.error(e);
		emitter.emit('error', e);
	});

	serial.on('close', function() {
		console.log('Disconnected.');

		// Forward close event
		emitter.emit('close');

		// Remove event listeners
		parser.removeAllEventListeners('response');
	});

	this.postCommand = function(command) {
		serial.write(command.encode());
	};
};

util.inherits(Connection, events.EventEmitter);
module.exports = Connection;